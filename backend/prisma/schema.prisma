// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// User roles: ADMIN, MANAGER, STAFF, KITCHEN
enum UserRole {
  ADMIN
  MANAGER
  STAFF
  KITCHEN
}

enum StaffStatus {
  ACTIVE
  INACTIVE
}

enum StaffPayType {
  HOURLY
  DAILY
  SALARY
}

enum ShiftStatus {
  SCHEDULED
  PUBLISHED
  COMPLETED
  CANCELLED
}

// Order status
enum OrderStatus {
  PENDING           // Waiting for payment
  PAID              // Payment confirmed
  PENDING_APPROVAL  // Waiting for staff approval (new)
  APPROVED          // Approved by staff, ready for kitchen (new)
  REJECTED          // Rejected by staff (new)
  WAITING           // Waiting to be prepared
  COOKING           // Being prepared
  COMPLETED         // Ready/Delivered
  CANCELLED         // Cancelled
}

// Payment status
enum PaymentStatus {
  PENDING
  PARTIAL       // For cake down payments
  PAID
  FAILED
}

// Language options
enum Language {
  ENGLISH
  INDONESIAN
}

enum WhatsAppMessageDirection {
  INBOUND
  OUTBOUND
}

// Users (Admin, Staff, Kitchen)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // hashed with bcrypt
  fullName  String
  role      UserRole @default(STAFF)
  isActive  Boolean  @default(true)
  isDemo    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders    Order[]  @relation("StaffOrders")
}

model Staff {
  id          String      @id @default(uuid())
  firstName   String
  lastName    String
  displayName String?
  phone       String?
  email       String?
  status      StaffStatus @default(ACTIVE)
  systemRole  UserRole    @default(STAFF)
  payType     StaffPayType?
  hourlyRate  Decimal?    @db.Decimal(10, 2)
  dailyRate   Decimal?    @db.Decimal(10, 2)
  salaryRate  Decimal?    @db.Decimal(10, 2) // Monthly salary
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  jobRoles    StaffJobRole[]
  shifts      Shift[]

  @@index([status])
  @@unique([email])
}

model JobRole {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staffAssignments StaffJobRole[]
  shifts           Shift[]

  @@unique([name])
}

model StaffJobRole {
  staffId   String
  jobRoleId String
  staff     Staff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  jobRole   JobRole @relation(fields: [jobRoleId], references: [id], onDelete: Cascade)

  @@id([staffId, jobRoleId])
  @@index([jobRoleId])
}

model Shift {
  id            String      @id @default(uuid())
  staffId       String
  staff         Staff       @relation(fields: [staffId], references: [id])
  startDateTime DateTime
  endDateTime   DateTime
  breakMinutes  Int         @default(0)
  roleOnShiftId String?
  roleOnShift   JobRole?    @relation(fields: [roleOnShiftId], references: [id])
  status        ShiftStatus @default(SCHEDULED)
  notes         String?
  createdBy     String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([staffId, startDateTime])
  @@index([startDateTime])
}

// Menu Items
model MenuItem {
  id          String       @id @default(uuid())
  name        String
  nameId      String?      // Indonesian name (optional)
  description String?
  descriptionId String?    // Indonesian description
  price       Decimal      @db.Decimal(10, 2)
  category    String
  imageUrl    String?      // Local file path
  stockQty    Int?         // For cabinet food
  isAvailable Boolean      @default(true)
  isActive    Boolean      @default(true)
  sizes       Json?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  orderItems  OrderItem[]

  @@index([category])
  @@index([isAvailable])
}

// Tables (for QR codes)
model Table {
  id          String   @id @default(uuid())
  tableNumber String   @unique
  qrCode      String?  // QR code data or file path
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  orders      Order[]
}

// Customer Orders
model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique // e.g., "ORD-20250105-001"
  customerName    String
  customerPhone   String        // WhatsApp number
  language        Language      @default(ENGLISH)
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  totalAmount     Decimal       @db.Decimal(10, 2)
  notes           String?

  // For cake orders
  isCakeOrder     Boolean       @default(false)
  cakePickupDate  DateTime?
  cakeNotes       String?
  downPaymentAmount Decimal?    @db.Decimal(10, 2)
  downPaymentDueDate DateTime?

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  paidAt          DateTime?
  cookingStartedAt DateTime?
  completedAt     DateTime?
  autoCleared     Boolean       @default(false)
  autoClearedAt   DateTime?
  tableCleared    Boolean       @default(false)
  tableClearedAt  DateTime?

  // Duration tracking (in minutes)
  preparationDuration Int?      // Time from order creation to cooking started
  cookingDuration     Int?      // Time from cooking started to completed
  totalDuration       Int?      // Total time from order creation to completed

  // Relations
  tableId         String?
  table           Table?        @relation(fields: [tableId], references: [id])
  staffId         String?
  staff           User?         @relation("StaffOrders", fields: [staffId], references: [id])
  orderItems      OrderItem[]
  payments        Payment[]

  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([customerPhone])
}

// Order Items (products in an order)
model OrderItem {
  id         String   @id @default(uuid())
  quantity   Int
  unitPrice  Decimal  @db.Decimal(10, 2)
  subtotal   Decimal  @db.Decimal(10, 2)
  notes      String?
  sizeLabel  String?

  // Relations
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([orderId])
}

// Payment records
model Payment {
  id            String        @id @default(uuid())
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod String        // QRIS, BANK_TRANSFER, CASH
  paymentProof  String?       // File path for proof
  notes         String?
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?

  // Relations
  orderId       String
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([orderId])
  @@index([status])
}

// System Settings
model Settings {
  id                  String   @id @default(uuid())

  // Business Info
  businessName        String   @default("My Cafe")
  businessNameId      String   @default("Kafe Saya")
  businessAddress     String?
  businessPhone       String?
  businessWhatsApp    String?
  businessEmail       String?

  // Location
  latitude            Decimal? @db.Decimal(10, 8)
  longitude           Decimal? @db.Decimal(11, 8)

  // Branding
  logoUrl             String?
  appIconUrl          String?
  ogImageUrl          String?  // Open Graph image for social sharing
  themeColor          String   @default("#4F46E5")

  // Bank Account (for cake payments)
  bankName            String?
  bankAccountHolder   String?
  bankAccountNumber   String?
  bankPaymentInstructions String?

  // Opening Hours
  openingHours        String?  // JSON string

  // Language
  defaultLanguage     Language @default(ENGLISH)
  enableEnglish       Boolean  @default(true)
  enableIndonesian    Boolean  @default(true)

  // Order Settings
  taxRate             Decimal  @default(10) @db.Decimal(5, 2)
  serviceChargeRate   Decimal  @default(5) @db.Decimal(5, 2)

  // Staff Approval Settings
  orderApprovalMode          String  @default("DIRECT") // "DIRECT" or "REQUIRES_APPROVAL"
  autoClearUnapprovedMinutes Int     @default(30)

  // Auto Clearing Settings
  autoClearingEnabled        Boolean @default(true)
  normalOrderClearHours      Decimal @default(1) @db.Decimal(5, 2)
  cakeOrderClearDays         Int     @default(2)

  // Down Payment Settings
  cakeDownPaymentPercentage  Int     @default(50)

  // Cabinet Foods Settings
  enableCabinetFoods  Boolean @default(true)

  // Currency Settings
  currency            String  @default("IDR") // IDR, USD, NZD, etc.

  // Upsell Settings
  upsellItemIds       String[] @default([])

  // Staff & Rostering Settings
  staffModuleEnabled       Boolean @default(true)
  payTypeOptionsEnabled    String[] @default(["HOURLY", "DAILY", "SALARY"])
  defaultPayType           String   @default("HOURLY")
  weekStartDay             String   @default("MON")
  shiftTimeGranularity     Int      @default(30)
  overlapRule              String   @default("BLOCK")
  rosterVisibility         String   @default("OWN")

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model WhatsAppSettings {
  id                 String   @id @default(uuid())
  enabled            Boolean  @default(false)
  phoneNumberId      String?
  businessAccountId  String?
  accessToken        String?
  webhookVerifyToken String?
  defaultCountryCode String?
  lastUpdatedAt      DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  logs WhatsAppLog[]
}

model WhatsAppLog {
  id                 String                   @id @default(uuid())
  whatsAppSettingsId String?
  whatsAppSettings   WhatsAppSettings?        @relation(fields: [whatsAppSettingsId], references: [id])
  direction          WhatsAppMessageDirection
  payload            Json
  statusCode         Int?
  errorMessage       String?
  createdAt          DateTime                 @default(now())

  @@index([direction])
}
